<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>فرم ثبت مشتری جدید (CRM)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        :root { --primary-color: #007bff; --success-color: #28a745; --danger-color: #dc3545; --light-gray: #f8f9fa; --dark-gray: #343a40; --border-color: #ced4da; } body { font-family: 'Vazirmatn', sans-serif; background-color: var(--light-gray); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; } .form-container { background-color: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1); width: 100%; max-width: 600px; box-sizing: border-box; } .form-container h1 { color: var(--dark-gray); margin-bottom: 30px; text-align: center; font-size: 24px; } .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #555; } .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; transition: border-color 0.3s, box-shadow 0.3s; } .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25); } .radio-group { display: flex; gap: 15px; border: 1px solid var(--border-color); border-radius: 8px; padding: 5px; } .radio-group label { flex: 1; text-align: center; padding: 10px; border-radius: 6px; cursor: pointer; transition: background-color 0.3s, color 0.3s; margin-bottom: 0; } .radio-group input[type="radio"] { display: none; } .radio-group input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; font-weight: 700; } textarea { resize: vertical; min-height: 100px; } .submit-btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: 700; cursor: pointer; transition: background-color 0.3s, transform 0.1s; display: flex; justify-content: center; align-items: center; gap: 10px; } .submit-btn:hover { background-color: #0056b3; } .submit-btn:active { transform: scale(0.98); } .submit-btn:disabled { background-color: #a0a0a0; cursor: not-allowed; } .spinner { width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; display: none; } @keyframes spin { to { transform: rotate(360deg); } } .popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); background-color: white; padding: 30px 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); z-index: 1000; text-align: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; } .popup.show { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); } .popup-icon { width: 80px; height: 80px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin: 0 auto 20px; } .popup-icon.success { background-color: #eaf7ec; } .popup-icon.error { background-color: #fdeeee; } .popup-icon svg { width: 40px; height: 40px; } .popup h2 { margin: 0; font-size: 22px; color: var(--dark-gray); }
    </style>
</head>
<body>

    <div class="form-container">
        <h1>👤 فرم ثبت مشتری جدید</h1>
        <form id="crm-form" action="https://zacii.app.n8n.cloud/webhook-test/c2c36f17-cdda-4e20-b53e-9008ba01f1ff" method="POST">
            
            <div class="form-group">
                <label for="customer_name">نام مشتری</label>
                <input type="text" id="customer_name" name="customer_name" required>
            </div>

            <div class="form-group">
                <label for="phone_number">شماره تماس</label>
                <input type="tel" id="phone_number" name="phone_number" pattern="[0-9]*" inputmode="numeric" required title="لطفاً فقط عدد وارد کنید.">
            </div>
            
            <div class="form-group">
                <label>نوع درخواست</label>
                <div class="radio-group">
                    <input type="radio" id="request_buy" name="request_type" value="خرید" checked>
                    <label for="request_buy">خرید</label>
                    
                    <input type="radio" id="request_rent" name="request_type" value="اجاره">
                    <label for="request_rent">اجاره</label>
                </div>
            </div>

            <div class="form-group">
                <label for="property_type">نوع ملک مورد نظر</label>
                <select id="property_type" name="property_type" required>
                    <option value="آپارتمان">آپارتمان</option>
                    <option value="ویلا">ویلا</option>
                    <option value="تجاری">تجاری</option>
                    <option value="زمین">زمین</option>
                    <option value="زمین کشاورزی">زمین کشاورزی</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="budget">بودجه (تومان)</label>
                <input type="text" id="budget" name="budget" inputmode="numeric" required placeholder="مثال: 5,000,000,000">
            </div>

            <div class="form-group">
                <label for="approximate_address">آدرس حدودی ملک مورد نظر</label>
                <input type="text" id="approximate_address" name="approximate_address">
            </div>

            <div class="form-group">
                <label for="description">توضیحات تکمیلی ملک مورد نظر</label>
                <textarea id="description" name="description" rows="4"></textarea>
            </div>

            <input type="hidden" name="shamsi_datetime">
            <input type="hidden" name="client_timezone_offset">

            <button type="submit" class="submit-btn" id="submit-button">
                <span class="spinner" id="spinner"></span>
                <span id="button-text">ثبت مشتری جدید</span>
            </button>
        </form>
    </div>

    <div class="popup" id="success-popup">
        <div class="popup-icon success">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="#28a745" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <h2>عملیات موفقیت آمیز بود</h2>
    </div>

    <div class="popup" id="error-popup">
        <div class="popup-icon error">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6L18 18" stroke="#dc3545" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </div>
        <h2>عملیات ناموفق بود</h2>
    </div>

    <script>
        const form = document.getElementById('crm-form');
        const submitButton = document.getElementById('submit-button');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('button-text');
        
        const successPopup = document.getElementById('success-popup');
        const errorPopup = document.getElementById('error-popup');
        
        const budgetInput = document.getElementById('budget');
        const phoneInput = document.getElementById('phone_number');

        budgetInput.addEventListener('input', (e) => {
            let numericValue = e.target.value.replace(/[^0-9]/g, '');
            if (numericValue) {
                const formattedValue = parseInt(numericValue, 10).toLocaleString('en-US');
                e.target.value = formattedValue;
            } else {
                e.target.value = '';
            }
        });
        
        phoneInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault(); 
            
            submitButton.disabled = true;
            spinner.style.display = 'block';
            buttonText.textContent = 'در حال ارسال...';
            
            const formData = new FormData(form);
            const budgetValue = budgetInput.value.replace(/,/g, '');
            formData.set('budget', budgetValue);

            // =======================================================
            // === افزودن تاریخ شمسی و ساعت محلی کاربر ===
            const now = new Date();
            
            // بخش تاریخ شمسی
            const gy = now.getFullYear();
            const gm = now.getMonth() + 1;
            const gd = now.getDate();
            const shamsi = jalaali.toJalaali(gy, gm, gd);
            const year = shamsi.jy;
            const month = shamsi.jm < 10 ? '0' + shamsi.jm : shamsi.jm;
            const day = shamsi.jd < 10 ? '0' + shamsi.jd : shamsi.jd;
            const formattedShamsiDate = `${year}/${month}/${day}`;

            // بخش ساعت محلی
            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const formattedHours = hours < 10 ? '0' + hours : hours;
            const formattedMinutes = minutes < 10 ? '0' + minutes : minutes;
            const formattedSeconds = seconds < 10 ? '0' + seconds : seconds;
            const formattedTime = `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
            
            // ترکیب تاریخ و ساعت
            const fullShamsiDateTime = `${formattedShamsiDate} ${formattedTime}`;

            // افزودن به پکیج ارسالی
            formData.append('shamsi_datetime', fullShamsiDateTime);
            formData.append('client_timezone_offset', now.getTimezoneOffset());
            // =======================================================

            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showPopup(successPopup);
                    form.reset();
                } else {
                    showPopup(errorPopup);
                }

            } catch (error) {
                console.error('Error submitting form:', error);
                showPopup(errorPopup);
            } finally {
                submitButton.disabled = false;
                spinner.style.display = 'none';
                buttonText.textContent = 'ثبت مشتری جدید';
            }
        });

        function showPopup(popupElement) {
            popupElement.classList.add('show');
            setTimeout(() => {
                popupElement.classList.remove('show');
            }, 3000);
        }
    </script>

</body>
</html>